name: AI Apply Change

on:
  workflow_dispatch:
    inputs:
      task:
        type: string
        required: true
        description: "Describe the change AI should apply"
      base_branch:
        type: string
        required: false
        default: "master"
      head_branch:
        type: string
        required: false
        default: "ai-edit-patch"

permissions:
  contents: write
  pull-requests: write

jobs:
  ai-edit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout base branch
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.base_branch }}
        fetch-depth: 0

    - name: Prepare working branch
      run: |
        BR="${{ inputs.head_branch }}"
        BASE="${{ inputs.base_branch }}"

        git fetch origin "$BR" || true
        if git rev-parse --verify "origin/$BR" >/dev/null 2>&1; then
          git checkout "$BR"
          git reset --hard "origin/$BR"
        else
          git checkout -B "$BR" "origin/$BASE"
        fi

    - name: Build AI prompt
      id: prompt
      run: |
        FILE="${RUNNER_TEMP}/prompt.txt"
        {
          echo "You are an AI code editor."
          echo "Generate a UNIFIED DIFF patch (git diff -u format)."
          echo "Do not explain. Only output the patch."
          echo
          echo "### USER TASK"
          printf "%s\n" "${{ inputs.task }}"
          echo
          echo "### FILE INDEX"
          git ls-files
          echo
        } > "$FILE"

        echo "prompt_file=$FILE" >> $GITHUB_OUTPUT

    - name: Call OpenAI (generate patch)
      id: ai
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        PROMPT=$(cat "${{ steps.prompt.outputs.prompt_file }}")

        RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
          -s \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $OPENAI_API_KEY" \
          -d "{
            \"model\": \"gpt-4.1\",
            \"messages\": [
              {\"role\": \"system\", \"content\": \"You generate git patches.\"},
              {\"role\": \"user\", \"content\": \"$PROMPT\"}
            ]
          }")

        PATCH=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

        PATCH_FILE="${RUNNER_TEMP}/change.patch"
        echo "$PATCH" > "$PATCH_FILE"

        echo "patch_file=$PATCH_FILE" >> $GITHUB_OUTPUT

    - name: Apply patch
      run: |
        set -e
        PATCH="${{ steps.ai.outputs.patch_file }}"

        if ! patch -p1 < "$PATCH" ; then
          echo "::error::Patch failed to apply."
          exit 1
        fi

    - name: Check diff
      id: diff
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit & Push
      if: steps.diff.outputs.changed == 'true'
      run: |
        git config user.email "ai-bot@users.noreply.github.com"
        git config user.name  "AI Patch Bot"

        git add -A
        git commit -m "AI auto-applied patch"
        git push --force origin "${{ inputs.head_branch }}"

    - name: Create or update PR
      if: steps.diff.outputs.changed == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const owner = context.repo.owner;
          const repo  = context.repo.repo;
          const head  = context.payload.inputs.head_branch;
          const base  = context.payload.inputs.base_branch;

          const prs = await github.rest.pulls.list({
            owner, repo, state: "open", head: `${owner}:${head}`
          });

          if (prs.data.length > 0) {
            core.notice("Existing PR: " + prs.data[0].html_url);
          } else {
            const pr = await github.rest.pulls.create({
              owner, repo,
              head,
              base,
              title: "AI auto-applied patch",
              body: "Changes applied automatically via OpenAI patch generation."
            });
            core.notice("Created PR: " + pr.data.html_url);
          }
