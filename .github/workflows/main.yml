- name: Run Codex (safe prompt; includes file index; no shell in sandbox)
  env:
    OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    RAW_TASK: ${{ inputs.task }}
  shell: bash
  run: |
    set -euo pipefail
    TMP="${RUNNER_TEMP:-/tmp}"
    PROMPT="${TMP}/task.txt"
    LOG="${TMP}/codex-transcript.log"

    # Write guardrail header via HEREDOC (note the quoted delimiter)
    cat > "$PROMPT" <<'HDR'
IMPORTANT: In the Codex sandbox, shell commands (rg, grep, find, ls, etc.) are NOT available.
Do NOT execute any shell commands or spawn processes.
Discover and open files by recursively listing and globbing within the current workspace ONLY,
and read/write files directly (no /tmp patches). Edit files IN-PLACE in this repository.

This repository is a .NET/C# SDK (yoti-dotnet-sdk). Focus ONLY on C#.
Ignore Java/JS/TS/Python/Go. Do not add non-.NET code or build files.
HDR

    printf '\n' >> "$PROMPT"

    # Append the user's task safely (no shell eval)
    printf -- '%s\n' "$RAW_TASK" >> "$PROMPT"
    printf '\n' >> "$PROMPT"

    # Append a repo file index so Codex can "see" files without shell tools in its sandbox
    {
      echo "BEGIN_FILE_INDEX"
      git ls-files
      echo "END_FILE_INDEX"
    } >> "$PROMPT"

    echo "===== BEGIN TASK (preview) ====="
    sed -n '1,120p' "$PROMPT" || true
    echo "=====  END TASK  ====="

    # Run Codex
    codex exec --model gpt-4o --full-auto -- "$(cat "$PROMPT")" 2>&1 | tee "$LOG"

    echo "Codex transcript saved at: $LOG"
    tail -n 200 "$LOG" || true
