name: AI Apply Change

on:
  workflow_dispatch:
    inputs:
      task:
        description: "Describe the feature/change AI should apply to the repo"
        type: string
        required: true
      base_branch:
        description: "Branch to start from"
        type: string
        required: false
        default: "master"
      head_branch:
        description: "Branch to push edits"
        type: string
        required: false
        default: "ai-auto-edit"

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-change:
    runs-on: ubuntu-latest

    steps:
    # 1) Checkout repo
    - name: Checkout base branch
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.base_branch }}
        fetch-depth: 0
        persist-credentials: true

    # 2) Prepare branch
    - name: Create or reset working branch
      run: |
        set -e
        BR="${{ inputs.head_branch }}"
        BASE="${{ inputs.base_branch }}"

        git fetch origin "$BR" || true

        if git rev-parse --verify "origin/$BR" >/dev/null 2>&1; then
          echo "Branch exists → resetting"
          git checkout "$BR"
          git reset --hard "origin/$BR"
        else
          echo "Creating new branch from base"
          git checkout -B "$BR" "origin/$BASE"
        fi

    # 3) Install OpenAI CLI
    - name: Install OpenAI CLI
      run: npm install -g openai

    # 4) Build AI prompt
    - name: Prepare AI Prompt
      id: prompt
      run: |
        PROMPT_FILE="${RUNNER_TEMP}/task.txt"

        {
          echo "IMPORTANT: Perform all code edits IN-PLACE within this repository."
          echo "Do not propose changes—apply them directly to the actual files."
          echo "Use your full code-editing (auto-editor) capabilities."
          echo
          echo "### USER TASK"
          printf "%s\n" "${{ inputs.task }}"
          echo
          echo "### FILE INDEX"
          echo "BEGIN_FILE_INDEX"
          git ls-files
          echo "END_FILE_INDEX"
          echo
          if [ -f AGENTS.md ]; then
            echo "### AGENT HINTS"
            sed 's/\r$//' AGENTS.md
            echo
          fi
        } > "$PROMPT_FILE"

        echo "prompt_path=$PROMPT_FILE" >> "$GITHUB_OUTPUT"

    # 5) RUN AI — this will modify the repository in-place
    - name: Run AI Code Editor
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        set -e
        PROMPT="${{ steps.prompt.outputs.prompt_path }}"

        # Call the new AI auto-editor
        openai assistant.exec \
          --model gpt-4.1 \
          --input "$(cat "$PROMPT")" \
          --directory .

        echo "AI edit completed."

    # 6) Detect changes
    - name: Check for changes
      id: detect
      run: |
        if git diff --quiet; then
          echo "changed=false" >> "$GITHUB_OUTPUT"
        else
          echo "changed=true" >> "$GITHUB_OUTPUT"
        fi

    # 7) Commit & Push
    - name: Commit and Push Changes
      if: steps.detect.outputs.changed == 'true'
      run: |
        git config user.email "ai-bot@users.noreply.github.com"
        git config user.name  "AI Auto Edit"

        git add -A
        git commit -m "AI auto-applied changes"
        git push --force origin "${{ inputs.head_branch }}"

    # 8) Open or update PR
    - name: Create or Update PR
      if: steps.detect.outputs.changed == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;

          const head = context.payload.inputs.head_branch;
          const base = context.payload.inputs.base_branch;

          const prs = await github.rest.pulls.list({
            owner,
            repo,
            state: "open",
            head: `${owner}:${head}`
          });

          if (prs.data.length > 0) {
            core.notice("PR already exists: " + prs.data[0].html_url);
          } else {
            const pr = await github.rest.pulls.create({
              owner,
              repo,
              head,
              base,
              title: "AI auto-applied changes",
              body: "This PR contains code edits applied automatically by the OpenAI assistant."
            });
            core.notice("Created PR: " + pr.data.html_url);
          }
