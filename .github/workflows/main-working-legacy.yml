name: Apply Codex Change - Legacy

on:
  workflow_dispatch:
    inputs:
      task:
        description: "Describe exactly what Codex should change"
        required: true
        type: string
      base_branch:
        description: "Base branch"
        default: "master"
        type: string
      head_branch:
        description: "Feature branch"
        default: "dev-text-codex-2"
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-codex-change:
    runs-on: ubuntu-latest

    steps:
      # CHECKOUT
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0
          persist-credentials: true

      # SWITCH / CREATE BRANCH
      - name: Prepare Git Branch
        run: |
          BR="${{ inputs.head_branch }}"
          BASE="${{ inputs.base_branch }}"
          git fetch origin "$BR" || true

          if git rev-parse --verify "origin/$BR" >/dev/null 2>&1; then
            git checkout -B "$BR" "origin/$BR"
          else
            git checkout -B "$BR" "origin/$BASE"
          fi

      # INSTALL CODEX 0.23 (the working version)
      - name: Install Codex CLI 0.23
        run: npm install -g @openai/codex@0.23.0

      # RUN CODEX VIA PTY (REAL PATCH APPLY)
      - name: Run Codex Auto-Editor (TUI forced)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          RAW_TASK: ${{ inputs.task }}
        run: |
          echo "$RAW_TASK" > task.txt

          # IMPORTANT: Codex UI must run under TTY to apply patches
           expect -c "
            log_user 1
            spawn codex --model gpt-5 --full-auto -- \"$(cat task.txt)\"
            set timeout -1
            expect eof
          "

      # VERIFY CHANGES
      - name: Verify workspace changed
        run: |
          echo "----- git status -----"
          git status --porcelain

          if ! git status --porcelain | grep -q .; then
            echo "::error title=Codex made no changes::No modifications detected."
            exit 1
          fi

      # COMMIT & PUSH
      - name: Commit & push changes
        id: commit_push
        run: |
          git config user.name "codex-bot"
          git config user.email "codex-bot@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "pushed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git commit -m "feat: Codex-applied changes"
          git push --set-upstream origin "${{ inputs.head_branch }}"
          echo "pushed=true" >> "$GITHUB_OUTPUT"

      # OPEN PR (IF PUSHED)
      - name: Open or update PR
        if: steps.commit_push.outputs.pushed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = context.payload.inputs.head_branch;
            const base = context.payload.inputs.base_branch;
            const task = context.payload.inputs.task;

            const { data: prs } = await github.rest.pulls.list({
              owner, repo, state: "open",
              head: `${owner}:${head}`,
            });

            if (prs.length) {
              core.notice(`Existing PR: ${prs[0].html_url}`);
            } else {
              const pr = await github.rest.pulls.create({
                owner, repo,
                title: "feat: Codex-applied changes",
                head,
                base,
                body: `Automated by Codex 0.23\n\n### Task\n${task}`,
              });

              core.notice(`PR created: ${pr.data.html_url}`);
            }
