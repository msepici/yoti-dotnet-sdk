name: Gemini Apply Change

on:
  workflow_dispatch:
    inputs:
      task:
        type: string
        description: "Describe the change Gemini should apply"
        required: true
      base_branch:
        type: string
        default: "master"
      head_branch:
        type: string
        default: "gemini-change"

permissions:
  contents: write
  pull-requests: write

jobs:
  edit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.base_branch }}
        fetch-depth: 0

    - name: Prepare branch
      run: |
        BR="${{ inputs.head_branch }}"
        BASE="${{ inputs.base_branch }}"

        git fetch origin "$BR" || true
        if git rev-parse --verify "origin/$BR" >/dev/null 2>&1; then
          git checkout "$BR"
          git reset --hard origin/$BR
        else
          git checkout -B "$BR" origin/$BASE
        fi

    - name: Install Gemini CLI
      run: npm install -g @google/gemini-cli

    - name: Run Gemini code edit
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        gemini code \
          --recursive \
          --edit "${{ inputs.task }}" \
          --yes



    - name: Check changes
      id: diff
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit & push
      if: steps.diff.outputs.changed == 'true'
      run: |
        git config user.email "ai-bot@users.noreply.github.com"
        git config user.name  "Gemini AI Bot"

        git add -A
        git commit -m "Gemini auto-applied changes"
        git push --force origin "${{ inputs.head_branch }}"

    - name: PR
      if: steps.diff.outputs.changed == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const owner = context.repo.owner;
          const repo  = context.repo.repo;
          const head  = context.payload.inputs.head_branch;
          const base  = context.payload.inputs.base_branch;

          const prs = await github.rest.pulls.list({
            owner, repo,
            state: "open",
            head: `${owner}:${head}`
          });

          if (prs.data.length) {
            core.notice("Existing PR: " + prs.data[0].html_url);
          } else {
            const pr = await github.rest.pulls.create({
              owner, repo,
              head,
              base,
              title: "Gemini auto-applied changes",
              body: "Gemini AI applied changes automatically."
            });

            core.notice("Created PR: " + pr.data.html_url);
          }
